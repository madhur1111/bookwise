<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reviews • Bookwise</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<header>
  <h1>Reviews</h1>
  <nav>
    <a href="/index.html">Home</a>
    <a href="/addReview.html">Add Review</a>
    <a href="/borrow.html">Borrow Records</a>
    <a href="/login.html" id="loginLink">Login</a>
    <a href="#" id="logoutLink" style="display:none">Logout</a>
  </nav>
</header>

<main class="container">
  <div class="card">
    <h2>Community Reviews</h2>
    <input id="search" placeholder="Search by title or author..." style="margin-top:10px">
    <select id="ratingFilter">
      <option value="">All Ratings</option>
      <option value="5">5★</option>
      <option value="4">4★ & above</option>
      <option value="3">3★ & above</option>
    </select>
  </div>
  <div id="list"></div>
</main>

<div id="toast"></div>

<script>
  const token=localStorage.getItem("token");
  const user=JSON.parse(localStorage.getItem("user")||"null");
  const loginLink=document.getElementById("loginLink");
  const logoutLink=document.getElementById("logoutLink");
  if(user){loginLink.style.display='none';logoutLink.style.display='inline';}
  logoutLink.addEventListener("click",e=>{e.preventDefault();localStorage.clear();location='/login.html';});

  let all=[];
  async function load() {
    const res=await fetch('/reviews');
    all=await res.json();
    render();
  }

  function render() {
    const q=document.getElementById("search").value.toLowerCase();
    const rf=document.getElementById("ratingFilter").value;
    let arr=all.filter(r=>!q||r.title.toLowerCase().includes(q)||r.author.toLowerCase().includes(q));
    if(rf==="5") arr=arr.filter(r=>r.rating==5);
    if(rf==="4") arr=arr.filter(r=>r.rating>=4);
    if(rf==="3") arr=arr.filter(r=>r.rating>=3);

    // Group by book title
    const grouped = {};
    arr.forEach(r=>{
      if(!grouped[r.title]) grouped[r.title]=[];
      grouped[r.title].push(r);
    });

    const list=document.getElementById("list"); list.innerHTML="";
    Object.keys(grouped).forEach(title=>{
      const reviews=grouped[title];
      const avg=(reviews.reduce((a,b)=>a+(b.rating||0),0)/reviews.length).toFixed(1);
      const container=document.createElement("div");
      container.className="card";
      container.innerHTML=`<h3>${escapeHtml(title)} - ⭐ ${avg} (${reviews.length} reviews)</h3>`;

      const btn=document.createElement("button");
      btn.textContent="View All Reviews";
      btn.onclick=()=>{
        details.style.display=details.style.display==="none"?"block":"none";
        btn.textContent=details.style.display==="none"?"View All Reviews":"Hide Reviews";
      };
      container.appendChild(btn);

      const details=document.createElement("div");
      details.style.display="none";
      reviews.forEach(r=>{
        const d=document.createElement("div");
        d.className="card";
        d.style.background="#f9f9f9";
        d.innerHTML=`<p><b>${escapeHtml(r.author)}</b> (${r.rating}★)</p>
                     <p>${escapeHtml(r.review)}</p>`;
        if(user&&user.role==="admin"){
          const b=document.createElement("button");
          b.textContent="Delete"; b.style.background="#ef4444";
          b.onclick=async()=>{
            if(!confirm("Delete review?")) return;
            const res=await fetch("/reviews/"+r._id,{method:"DELETE",headers:{Authorization:"Bearer "+token}});
            if(res.ok){showToast("Review deleted");load();}
          };
          d.appendChild(b);
        }
        details.appendChild(d);
      });
      container.appendChild(details);
      list.appendChild(container);
    });
  }

  function escapeHtml(s){return String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
  function showToast(m){const t=document.getElementById("toast");t.textContent=m;t.className="show";setTimeout(()=>t.className="",2500);}
  document.getElementById("search").addEventListener("input",render);
  document.getElementById("ratingFilter").addEventListener("change",render);
  load();
</script>
</body>
</html>
